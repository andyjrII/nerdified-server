// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id           Int                @id @default(autoincrement())
  name         String?
  email        String             @unique
  phoneNumber  String?            @unique
  password     String
  refreshToken String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  imagePath    String?
  address      String
  courses      CourseEnrollment[]
  review       Review[]
  wishlist     Wishlist[]
  messagesSent DirectMessage[]    @relation("SenderMessages")
  messagesReceived DirectMessage[] @relation("ReceiverMessages")
  sessionBookings SessionBooking[]
  sessionAttendance SessionAttendance[]
  notifications Notification[]

  @@map("students")
}

model Tutor {
  id                Int                  @id @default(autoincrement())
  name              String?
  email              String               @unique
  phoneNumber        String?              @unique
  password           String
  refreshToken       String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  imagePath          String?
  bio                String?
  qualifications     String?
  approved           Boolean              @default(false)
  approvedAt         DateTime?
  approvedBy         Admin?               @relation(fields: [approvedById], references: [id])
  approvedById       Int?
  timezone           String?              // IANA timezone e.g. "America/New_York" for availability & display
  courses            Course[]
  availability       TutorAvailability[]
  sessions           Session[]
  messagesSent       DirectMessage[]      @relation("TutorSentMessages")
  messagesReceived   DirectMessage[]      @relation("TutorReceivedMessages")
  payouts            TutorPayout[]

  @@map("tutors")
}

model Course {
  id                  Int                @id @default(autoincrement())
  title               String
  description         String?
  price               Decimal            @default(0) @db.Decimal(10, 2)
  priceOneOnOne       Decimal?           @db.Decimal(10, 2) // When courseType BOTH, 1:1 price (higher)
  courseType          COURSETYPE         @default(ONE_ON_ONE)
  maxStudents         Int?               // For group classes, null means one-on-one
  maxOneOnOneStudents Int?               // When courseType BOTH, cap for 1:1 enrollments
  curriculum          String?            // JSON or text
  outcomes        String?            // Learning outcomes
  status          COURSESTATUS       @default(DRAFT) // DRAFT until sessions added & tutor publishes
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  tutor           Tutor              @relation(fields: [tutorId], references: [id])
  tutorId         Int
  enrollments     CourseEnrollment[]
  review          Review[]
  wishlist        Wishlist[]
  sessions        Session[]
  chatMessages    CourseChatMessage[]
  addSessionRequests AddSessionRequest[]

  @@unique([tutorId, title])
  @@map("courses")
}

model CourseEnrollment {
  id              Int              @id @default(autoincrement())
  student         Student          @relation(fields: [studentId], references: [id])
  studentId       Int
  course          Course           @relation(fields: [courseId], references: [id])
  courseId        Int
  deliveryMode    DELIVERYMODE?    // When course BOTH: GROUP or ONE_ON_ONE
  oneOnOneSessions Session[]       // 1:1 sessions agreed via chat
  dateEnrolled    DateTime         @default(now())
  paidAmount      Decimal          @db.Decimal(10, 2)
  status          ENROLLMENTSTATUS @default(PENDING)
  reference       String
  completedAt     DateTime?
  certificateUrl  String?

  @@map("courseenrolment")
}

model TutorAvailability {
  id          Int       @id @default(autoincrement())
  tutor       Tutor     @relation(fields: [tutorId], references: [id])
  tutorId     Int
  dayOfWeek   DAYOFWEEK
  startTime   String    // Format: "HH:mm" (e.g., "09:00")
  endTime     String    // Format: "HH:mm" (e.g., "17:00")
  isAvailable Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tutor_availability")
}

model Session {
  id              Int              @id @default(autoincrement())
  course          Course           @relation(fields: [courseId], references: [id])
  courseId        Int
  tutor           Tutor            @relation(fields: [tutorId], references: [id])
  tutorId         Int
  sessionType     SESSIONTYPE      @default(GROUP) // GROUP = shared; ONE_ON_ONE = agreed via chat
  enrollment      CourseEnrollment? @relation(fields: [enrollmentId], references: [id])
  enrollmentId    Int?             // For ONE_ON_ONE: links to the 1:1 enrollment this session is for
  title           String?
  description     String?
  startTime       DateTime
  endTime         DateTime
  status          SESSIONSTATUS    @default(SCHEDULED)
  meetingUrl      String?          // Video meeting URL (Agora/LiveKit room)
  recordingUrl    String?          // Session recording URL
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bookings        SessionBooking[]
  attendance      SessionAttendance[]
  rescheduleRequests RescheduleRequest[]

  @@map("sessions")
}

model RescheduleRequest {
  id                Int       @id @default(autoincrement())
  session           Session   @relation(fields: [sessionId], references: [id])
  sessionId         Int
  requestedStartTime DateTime
  requestedEndTime   DateTime
  reason            String
  status            REQUESTSTATUS @default(PENDING)
  requestedByTutorId Int      // tutor who requested
  reviewedByAdminId  Int?     // admin who approved/rejected
  reviewedAt         DateTime?
  adminNote          String?
  createdAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("reschedule_requests")
}

model AddSessionRequest {
  id                Int       @id @default(autoincrement())
  course            Course    @relation(fields: [courseId], references: [id])
  courseId          Int
  startTime         DateTime
  endTime           DateTime
  title             String?
  description       String?
  reason            String
  status            REQUESTSTATUS @default(PENDING)
  requestedByTutorId Int
  reviewedByAdminId  Int?
  reviewedAt         DateTime?
  adminNote          String?
  createdAt          DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("add_session_requests")
}

model SessionBooking {
  id              Int              @id @default(autoincrement())
  session         Session          @relation(fields: [sessionId], references: [id])
  sessionId       Int
  student         Student          @relation(fields: [studentId], references: [id])
  studentId       Int
  status          BOOKINGSTATUS    @default(CONFIRMED)
  bookedAt        DateTime         @default(now())
  cancelledAt     DateTime?

  @@unique([sessionId, studentId])
  @@map("session_bookings")
}

model SessionAttendance {
  id              Int              @id @default(autoincrement())
  session         Session          @relation(fields: [sessionId], references: [id])
  sessionId       Int
  student         Student          @relation(fields: [studentId], references: [id])
  studentId       Int
  attended        Boolean          @default(false)
  joinedAt        DateTime?
  leftAt          DateTime?
  createdAt       DateTime         @default(now())

  @@unique([sessionId, studentId])
  @@map("session_attendance")
}

model DirectMessage {
  id              Int              @id @default(autoincrement())
  senderType      SENDERTYPE
  studentSender   Student?         @relation("SenderMessages", fields: [studentSenderId], references: [id])
  studentSenderId Int?
  tutorSender     Tutor?           @relation("TutorSentMessages", fields: [tutorSenderId], references: [id])
  tutorSenderId   Int?
  studentReceiver Student?         @relation("ReceiverMessages", fields: [studentReceiverId], references: [id])
  studentReceiverId Int?
  tutorReceiver   Tutor?           @relation("TutorReceivedMessages", fields: [tutorReceiverId], references: [id])
  tutorReceiverId Int?
  message         String
  read            Boolean          @default(false)
  readAt          DateTime?
  createdAt       DateTime         @default(now())

  @@map("direct_messages")
}

model CourseChatMessage {
  id              Int              @id @default(autoincrement())
  course          Course           @relation(fields: [courseId], references: [id])
  courseId        Int
  senderId        Int              // Student or Tutor ID
  senderType      SENDERTYPE
  message         String
  isAnnouncement  Boolean          @default(false) // If true, only tutors can send
  createdAt       DateTime         @default(now())

  @@map("course_chat_messages")
}

model TutorPayout {
  id              Int              @id @default(autoincrement())
  tutor           Tutor            @relation(fields: [tutorId], references: [id])
  tutorId         Int
  amount          Decimal          @db.Decimal(10, 2)
  commission      Decimal          @db.Decimal(10, 2) // Platform commission
  netAmount       Decimal          @db.Decimal(10, 2) // Amount after commission
  status          PAYOUTSTATUS     @default(PENDING)
  paymentReference String?
  paidAt          DateTime?
  createdAt       DateTime         @default(now())

  @@map("tutor_payouts")
}

model Notification {
  id              Int              @id @default(autoincrement())
  student         Student?         @relation(fields: [studentId], references: [id])
  studentId       Int?
  tutorId         Int?             // For tutor notifications (can add Tutor relation later if needed)
  type            NOTIFICATIONTYPE
  title           String
  message         String
  read            Boolean          @default(false)
  readAt          DateTime?
  link            String?
  createdAt       DateTime         @default(now())

  @@map("notifications")
}

model Review {
  id        Int      @id @default(autoincrement())
  student   Student  @relation(fields: [studentId], references: [id])
  studentId Int
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  Int
  rating    Int
  comment   String
  createdAt DateTime @default(now())

  @@map("reviews")
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  student   Student  @relation(fields: [studentId], references: [id])
  studentId Int
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  Int
  createdAt DateTime @default(now())

  @@unique([studentId, courseId])
  @@map("wishlists")
}

model Blog {
  id         Int      @id @default(autoincrement())
  title      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  datePosted DateTime
  postUrl    String   @unique
  imagePath  String?

  @@map("blog")
}

model Admin {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String
  refreshToken String?
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  role         UserRole @default(SUB_ADMIN)
  approvedTutors Tutor[]

  @@map("admin")
}

// Enums
enum UserRole {
  STUDENT
  TUTOR
  SUPER_ADMIN
  SUB_ADMIN
}

enum ENROLLMENTSTATUS {
  PENDING
  STARTED
  DROPPED
  FINISHED
}

enum CLASSDAY {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum TIMEOFDAY {
  MORNING
  AFTERNOON
  EVENING
}

enum MODE {
  ONLINE
  ONSITE
}

enum COURSETYPE {
  ONE_ON_ONE
  GROUP
  BOTH
}

enum DELIVERYMODE {
  GROUP
  ONE_ON_ONE
}

enum SESSIONTYPE {
  GROUP
  ONE_ON_ONE
}

enum COURSESTATUS {
  DRAFT
  PUBLISHED
}

enum REQUESTSTATUS {
  PENDING
  APPROVED
  REJECTED
}

enum DAYOFWEEK {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum SESSIONSTATUS {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BOOKINGSTATUS {
  CONFIRMED
  CANCELLED
  ATTENDED
  NO_SHOW
}

enum SENDERTYPE {
  STUDENT
  TUTOR
}

enum PAYOUTSTATUS {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum NOTIFICATIONTYPE {
  CLASS_REMINDER
  SCHEDULE_CHANGE
  MESSAGE
  ENROLLMENT
  PAYMENT
  SYSTEM
}
